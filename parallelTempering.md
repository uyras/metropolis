Описание алгоритма параллельного отжига
======

# todo в порядке убывания важности

- [x] сохранять статистику обменов конфигурациями
- [x] вернуть вывод конечных конфигураций в раздел final notes
- [x] переделать опрос температур сверху вниз
- [x] попробовать после обмена температур сделать один холостой МК-шаг
- [ ] исправить вычисляемые параметры
- [ ] добавить вывод конфигурации параллельного отжига на экран в балансере manual
- [ ] добавить больше примеров
- [ ] перенести инициализацию вычисляемых параметров в сами классы этих параметров
- [ ] в классе магнитной системы переименовать size на N
- [ ] распихать классы по папкам
- [ ] актуализировать документацию
- [ ] добавить MPI реализацию параллелизма

---
Параллельный отжиг встроен в классический Метрополис.
Алгоритм Метрополиса работает в параллельном режима. Точка параллелизма - температуры. То есть, каждый свободный поток (процесс) программы обрабатывает свою температуру из параметра ini-файла main/temperatures.

Параллельный отжиг делает параллелизм так же по температурам, но с учетом реплик параллельного отжига. То есть, главный цикл for теперь итерирует по классу балансира температур, в котором заданы все базовые температуры и температуры из реплик.
Внутренняя структура хранения температур в классе не регламентируется, но установлен интерфейс доступа к ним из программы:
```c++
unsigned size(); //общее число температур
unsigned sizeBase(); //число базовых температур
unsigned size(unsigned baseNum); //число реплик для базовой температуры baseNum
double at(unsigned baseNum, unsigned replicaNum); //получить температуру для базового номера baseNum и реплики replicaNum.
```

Алгоритм параллельного отжига:
1. баланс температур (одним из алгоритмов)
2. прогрев (сразу с параллельным отжигом)
3. боевой МК (с параллельным отжигом)

## Конфигурация

Алгоритм включается когда в ini-файле добавлена секция параллельного отжига с двумя обязательными параметрами:

```ini
[parallel_tempering]
balancer = simple ; алгоритм балансировки
each_step = 1000 ; каждые сколько шагов делать обмен
```

Отсутствие двух параметров, но наличие секции приводит к ошибке запуска программы.
Параметр `balancer` отвечает за алгоритм балансировки температур. Для каждого алгоритма балансировки в ini-файле должна присутствовать соответствующая подсекция с параметрами балансира температур.

## Алгоритмы балансировки и их параметры

### `balancer='manual'`

Алгоритм с возможностью ручной установки температур.

Параметры в конфиг файле:
```ini
[parallel_tempering.balancer.manual]
t0 = 1.1, 2.2, 3.3, 4.4, 5.5
t1 = 2.2, 3.3, 4.4, 5.5, 6.6
t2 = 1.2, 2.3, 3.4, 4.5
```
Для каждой базовой температуры из секции `main/temperature`  создается параметр `t<N>` где `<N>` - порядковый номер, счет начинается с 0. Значениями параметра являются температуры реплик. 
Значения автоматически сортируются при старте программы.
Если для базовой температуры не установлены температуры реплик, то эта температура вычисляется с использованием классического алгоритма Метрополиса.

### `balancer='unispace'`

Алгоритм балансировки с равномерным распределением температур.
Берется базовая температура $T_i$. Температура реплики $j$: $T^j_i = T_i + j \cdot \Delta T$, где $\Delta T$ - шаг по температуре. 

```ini
[parallel_tempering.balancer.unispace]
dt = 0.1 ; шаг по температуре
n = 5 ; количество реплик для каждой базовой температуре
```

### `balancer='fixed_exchange'`

Алгоритм балансировки, основанный на фиксированной вероятности обмена репликами. Количество реплик и их температуры определяются в ходе предварительного отжига. Алгоритму нельзя использовать температуры реплик больше чем `t_max`. Если базовая температура больше чем `t_max`, то для ней не будет реплик - она считается классическим алгоритмом Метрополиса.

Параметры балансира:
```ini
[parallel_tempering.balancer.fixed_exchange]
shoot_cycles = 3 ; сколько циклов пристрелки
exchange_rate = 0.2 ; какой частоты обмена конфигураций придерживаться. Значение от 0 до 1.
t_max  = 10 ; максимальный порог значения температуры для реплики
```

## Интерфейс класса балансира

Установка строкового значения `parallel_tempering/balancer` приводит к созданию соответствующего класса балансира. Указатель на этот экземпляр класса записывается в параметр `ConfigManager->temperatures`. Соответствие строкового значения с именем класса определяется в файле `PtBalancerFactory.h` в функции `PtBalancerInterface * balancerFactory(string type)`.

Интерфейс определен в классе `PtBalancerInterface.h`.

Реализация по умолчанию задана в `PtBalancerDefault.h` - она реализуется если в файле отсутствует секция `[parallel_tempering]` и представляет собой простой список температур.